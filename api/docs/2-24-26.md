# 2-24-26 — Notes & Posts API

---

## Notes

All routes prefixed with `/data`. Notes attach to a `post`, `interactions_graph`, or `followers_graph`. Visibility is `private` (author only) or `public`. Full docs: [notes.md](notes.md).

### Routes

| Method | Route | Description |
|--------|-------|-------------|
| `POST` | `/data/create_note` | Create a note |
| `GET` | `/data/get_note/<note_id>?user_id=` | Get one note by ID |
| `GET` | `/data/get_notes_for_target?target_type=&target_id=&user_id=` | Get notes for a post or entity graph |
| `GET` | `/data/get_notes_by_author?author_id=` | Get all notes by a user |
| `POST` | `/data/update_note/<note_id>` | Update title / content / visibility |
| `POST` | `/data/archive_note/<note_id>` | Archive a note |
| `POST` | `/data/delete_note/<note_id>` | Soft-delete a note |

### Note Object

```json
{
  "id": 1,
  "author_id": 1,
  "title": "Q1 observation",
  "content": "Engagement dropped after Feb 10.",
  "target_type": "interactions_graph",
  "target_id": 3,
  "context_data": { "date_range": "2026-02-01/2026-02-20" },
  "visibility": "private",
  "status": "active",
  "created_at": "2026-02-24T10:00:00",
  "updated_at": null
}
```

---

## Posts

All routes prefixed with `/data`. Posts are **read-only**, sourced from `posts_mv` and `posts_history_mv` materialized views. Full docs: [posts.md](posts.md).

### Routes

| Method | Route | Description |
|--------|-------|-------------|
| `GET` | `/data/get_post?page_id=&platform=&post_id=` | Single post by composite key |
| `GET` | `/data/get_posts_by_platform?platform=` | All latest posts for a platform |
| `GET` | `/data/get_posts_by_page?page_id=&platform=` | All latest posts for a page |
| `GET` | `/data/get_posts_by_entity?entity_id=&platform=` | All latest posts for an entity |
| `GET` | `/data/get_post_history?page_id=&platform=&post_id=` | Full snapshot history for a post |

### Post Object

```json
{
  "page_id": "uuid",
  "platform": "instagram",
  "post_id": "ABC123",
  "created_at": "2026-01-15T10:30:00",
  "recorded_at": "2026-02-24T06:00:00",
  "url": "https://...",
  "likes": 1500,
  "comments": 42,
  "shares": null,
  "views": null,
  "caption": "Post caption text",
  "content_type": "photo",
  "image_url": "https://...",
  "video_url": null,
  "is_pinned": false,
  "extra_data": {}
}
```

### Data sources

| View | Description |
|------|-------------|
| `posts_mv` | Latest snapshot per `(page_id, platform, post_id)` |
| `posts_history_mv` | Full time-series — one row per snapshot per post |

Refresh both after every scrape cycle:
```sql
REFRESH MATERIALIZED VIEW CONCURRENTLY posts_history_mv;
REFRESH MATERIALIZED VIEW CONCURRENTLY posts_mv;
```
